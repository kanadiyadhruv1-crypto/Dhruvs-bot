<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>Universal AI Chat</title>

<!-- Tailwind CSS CDN -->
<link href="https://cdn.tailwindcss.com" rel="stylesheet"/>

<!-- Google Fonts: Geist-like via Inter for body, mono for code -->
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet"/>

<!-- marked.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/lib/marked.min.js"></script>

<style>
/* â”€â”€â”€ CSS Variables & Base â”€â”€â”€ */
:root {
  --bg-primary: #ffffff;
  --bg-secondary: #f4f6f8;
  --bg-hover: #eef1f4;
  --bg-input: #ffffff;
  --bg-modal: #ffffff;
  --bg-code: #f0f2f5;
  --text-primary: #1a1d23;
  --text-secondary: #6b7280;
  --text-muted: #9ca3af;
  --border: #e2e5ea;
  --accent: #1a73e8;
  --accent-hover: #1662c4;
  --accent-light: rgba(26,115,232,0.08);
  --sidebar-width: 280px;
  --shadow: 0 1px 3px rgba(0,0,0,0.08);
  --shadow-lg: 0 4px 20px rgba(0,0,0,0.12);
  --radius: 12px;
  --user-bubble: #1a73e8;
  --user-text: #ffffff;
  --ai-bubble: #f0f2f5;
  --ai-text: #1a1d23;
  --danger: #ef4444;
  --danger-hover: #dc2626;
}

[data-theme="dark"] {
  --bg-primary: #0f1117;
  --bg-secondary: #171921;
  --bg-hover: #1e2128;
  --bg-input: #171921;
  --bg-modal: #1a1d24;
  --bg-code: #141618;
  --text-primary: #e8eaed;
  --text-secondary: #9aa0a6;
  --text-muted: #6e7479;
  --border: #2a2e35;
  --accent: #4da8ff;
  --accent-hover: #6cb9ff;
  --accent-light: rgba(77,168,255,0.1);
  --shadow: 0 1px 4px rgba(0,0,0,0.3);
  --shadow-lg: 0 4px 24px rgba(0,0,0,0.4);
  --user-bubble: #1a73e8;
  --user-text: #ffffff;
  --ai-bubble: #1e2128;
  --ai-text: #e8eaed;
  --danger: #f07070;
  --danger-hover: #ff5555;
}

*, *::before, *::after { box-sizing: border-box; }

html, body {
  margin: 0;
  padding: 0;
  min-height: 100%;
  min-height: 100dvh;
  font-family: 'DM Sans', system-ui, -apple-system, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  transition: background 0.3s, color 0.3s;
  -webkit-font-smoothing: antialiased;
  overscroll-behavior: none;
}

/* â”€â”€â”€ Loading Screen â”€â”€â”€ */
#loading {
  position: fixed; inset: 0;
  display: flex; align-items: center; justify-content: center;
  background: var(--bg-primary);
  color: var(--text-secondary);
  font-size: 1rem; letter-spacing: 0.04em;
  z-index: 9999;
  transition: opacity 0.4s;
}
#loading.hidden { opacity: 0; pointer-events: none; }

/* â”€â”€â”€ App Shell â”€â”€â”€ */
#app {
  display: flex;
  min-height: 100dvh;
  min-height: 100vh;
  opacity: 0;
  transition: opacity 0.4s;
}
#app.visible { opacity: 1; }

/* â”€â”€â”€ Sidebar â”€â”€â”€ */
#sidebar {
  width: var(--sidebar-width);
  min-width: var(--sidebar-width);
  background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  height: 100dvh;
  height: 100vh;
  position: fixed;
  left: 0; top: 0;
  z-index: 100;
  transition: transform 0.3s cubic-bezier(.4,0,.2,1), background 0.3s, border-color 0.3s;
}
#sidebar.hidden { transform: translateX(-100%); }

.sidebar-overlay {
  display: none;
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 99;
}
.sidebar-overlay.show { display: block; }

/* â”€â”€â”€ Sidebar Header â”€â”€â”€ */
.sidebar-header {
  padding: 20px 16px 12px;
  display: flex; align-items: center; gap: 10px;
}
.sidebar-logo {
  width: 32px; height: 32px;
  background: var(--accent);
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
}
.sidebar-logo svg { width: 18px; height: 18px; }
.sidebar-title { font-size: 0.9rem; font-weight: 600; color: var(--text-primary); }

/* â”€â”€â”€ New Chat Button â”€â”€â”€ */
#newChatBtn {
  margin: 4px 12px 8px;
  padding: 10px 14px;
  border-radius: 10px;
  border: 1.5px dashed var(--border);
  background: transparent;
  color: var(--text-secondary);
  font-family: inherit;
  font-size: 0.855rem;
  font-weight: 500;
  cursor: pointer;
  display: flex; align-items: center; gap: 8px;
  transition: all 0.2s;
}
#newChatBtn:hover {
  background: var(--accent-light);
  border-color: var(--accent);
  color: var(--accent);
}
#newChatBtn svg { width: 16px; height: 16px; flex-shrink: 0; }

/* â”€â”€â”€ Chat List â”€â”€â”€ */
#chatList {
  flex: 1;
  overflow-y: auto;
  padding: 4px 10px 80px;
}
#chatList::-webkit-scrollbar { width: 5px; }
#chatList::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

.chat-item {
  display: flex; align-items: center; gap: 8px;
  padding: 9px 10px;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.15s;
  position: relative;
}
.chat-item:hover { background: var(--bg-hover); }
.chat-item.active { background: var(--accent-light); }
.chat-item-icon { font-size: 0.9rem; flex-shrink: 0; }
.chat-item-name {
  flex: 1; min-width: 0;
  font-size: 0.835rem;
  color: var(--text-primary);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  transition: color 0.2s;
}
.chat-item.active .chat-item-name { color: var(--accent); font-weight: 500; }
.chat-item-actions {
  display: none; gap: 2px; flex-shrink: 0;
}
.chat-item:hover .chat-item-actions { display: flex; }
.chat-item-actions button {
  background: none; border: none; cursor: pointer;
  color: var(--text-muted); padding: 3px;
  border-radius: 5px; transition: color 0.15s, background 0.15s;
  display: flex; align-items: center; justify-content: center;
}
.chat-item-actions button:hover { background: var(--bg-hover); color: var(--text-secondary); }
.chat-item-actions button.danger:hover { color: var(--danger); }
.chat-item-actions svg { width: 14px; height: 14px; }

/* Rename input */
.chat-item-name-input {
  flex: 1; min-width: 0;
  background: var(--bg-input);
  border: 1px solid var(--accent);
  border-radius: 5px;
  padding: 2px 6px;
  font-size: 0.835rem;
  font-family: inherit;
  color: var(--text-primary);
  outline: none;
}

/* â”€â”€â”€ Sidebar Footer â”€â”€â”€ */
.sidebar-footer {
  padding: 12px 14px;
  border-top: 1px solid var(--border);
  display: flex; align-items: center; gap: 10px;
}
.sidebar-footer button {
  background: none; border: none; cursor: pointer;
  color: var(--text-secondary); padding: 6px;
  border-radius: 8px; transition: all 0.2s;
  display: flex; align-items: center;
}
.sidebar-footer button:hover { background: var(--bg-hover); color: var(--text-primary); }
.sidebar-footer svg { width: 20px; height: 20px; }
.sidebar-footer .footer-spacer { flex: 1; }

/* â”€â”€â”€ Main Content â”€â”€â”€ */
#mainContent {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 100dvh;
  min-height: 100vh;
  margin-left: var(--sidebar-width);
  transition: margin-left 0.3s cubic-bezier(.4,0,.2,1);
}

/* â”€â”€â”€ Top Bar (mobile) â”€â”€â”€ */
.top-bar {
  display: none;
  align-items: center; gap: 10px;
  padding: 12px 16px 8px;
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border);
  position: sticky; top: 0; z-index: 50;
}
.top-bar button {
  background: none; border: none; cursor: pointer;
  color: var(--text-secondary); padding: 6px;
  border-radius: 8px; transition: all 0.15s;
}
.top-bar button:hover { background: var(--bg-hover); color: var(--text-primary); }
.top-bar svg { width: 22px; height: 22px; }
.top-bar-title {
  font-size: 0.9rem; font-weight: 600; color: var(--text-primary);
  flex: 1; text-align: center;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* â”€â”€â”€ Messages Area â”€â”€â”€ */
#messagesArea {
  flex: 1;
  overflow-y: auto;
  padding: 24px 16px 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
#messagesArea::-webkit-scrollbar { width: 6px; }
#messagesArea::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

.messages-inner {
  width: 100%; max-width: 720px;
  display: flex; flex-direction: column; gap: 16px;
}

/* â”€â”€â”€ Welcome Screen â”€â”€â”€ */
#welcomeScreen {
  flex: 1;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  text-align: center;
  padding: 40px 20px;
  min-height: 200px;
}
.welcome-icon {
  width: 64px; height: 64px;
  background: linear-gradient(135deg, var(--accent), #7cb9ff);
  border-radius: 18px;
  display: flex; align-items: center; justify-content: center;
  margin-bottom: 20px;
  box-shadow: 0 4px 16px rgba(26,115,232,0.3);
}
.welcome-icon svg { width: 32px; height: 32px; color: #fff; }
.welcome-title {
  font-size: 1.5rem; font-weight: 600;
  color: var(--text-primary); margin-bottom: 8px;
}
.welcome-sub {
  font-size: 0.9rem; color: var(--text-secondary);
  max-width: 380px; line-height: 1.5;
}

/* â”€â”€â”€ Message Bubbles â”€â”€â”€ */
.message {
  display: flex; gap: 10px;
  animation: fadeSlideIn 0.25s ease;
}
@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}
.message.user { flex-direction: row-reverse; }

.message-avatar {
  width: 32px; height: 32px; min-width: 32px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.78rem; font-weight: 600;
  flex-shrink: 0;
}
.message.user .message-avatar { background: var(--accent); color: #fff; }
.message.ai .message-avatar { background: var(--ai-bubble); color: var(--text-secondary); border: 1px solid var(--border); }

.message-bubble {
  max-width: calc(100% - 42px);
  padding: 10px 14px;
  border-radius: 16px;
  font-size: 0.9rem;
  line-height: 1.6;
  word-break: break-word;
  box-shadow: var(--shadow);
  transition: background 0.3s, color 0.3s;
}
.message.user .message-bubble {
  background: var(--user-bubble);
  color: var(--user-text);
  border-bottom-right-radius: 4px;
}
.message.ai .message-bubble {
  background: var(--ai-bubble);
  color: var(--ai-text);
  border-bottom-left-radius: 4px;
}

/* â”€â”€â”€ Markdown Inside AI Bubbles â”€â”€â”€ */
.message-bubble p { margin: 0 0 8px; }
.message-bubble p:last-child { margin-bottom: 0; }
.message-bubble h1, .message-bubble h2, .message-bubble h3,
.message-bubble h4, .message-bubble h5, .message-bubble h6 {
  margin: 12px 0 6px; font-weight: 600; color: var(--text-primary);
}
.message-bubble h1 { font-size: 1.35rem; }
.message-bubble h2 { font-size: 1.15rem; }
.message-bubble h3 { font-size: 1rem; }
.message-bubble ul, .message-bubble ol { margin: 6px 0; padding-left: 20px; }
.message-bubble li { margin-bottom: 4px; }
.message-bubble code {
  font-family: 'DM Mono', 'Fira Code', monospace;
  font-size: 0.82rem;
  background: var(--bg-code);
  color: var(--accent);
  padding: 2px 6px;
  border-radius: 5px;
  border: 1px solid var(--border);
}
.message-bubble pre {
  background: var(--bg-code);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow-x: auto;
  padding: 12px 14px;
  margin: 8px 0;
  position: relative;
}
.message-bubble pre code {
  background: none; border: none; padding: 0;
  color: var(--text-primary);
  font-size: 0.81rem;
  line-height: 1.55;
}
.message-bubble blockquote {
  border-left: 3px solid var(--accent);
  padding: 4px 12px;
  margin: 8px 0;
  background: var(--accent-light);
  border-radius: 0 6px 6px 0;
  color: var(--text-secondary);
  font-style: italic;
}
.message-bubble table { border-collapse: collapse; width: 100%; margin: 8px 0; font-size: 0.85rem; }
.message-bubble th, .message-bubble td {
  border: 1px solid var(--border); padding: 6px 10px; text-align: left;
}
.message-bubble th { background: var(--bg-code); font-weight: 600; }
.message-bubble hr { border: none; border-top: 1px solid var(--border); margin: 10px 0; }
.message-bubble a { color: var(--accent); text-decoration: none; }
.message-bubble a:hover { text-decoration: underline; }
.message-bubble img { max-width: 100%; border-radius: 8px; }

/* â”€â”€â”€ Typing Indicator â”€â”€â”€ */
.typing-indicator {
  display: flex; gap: 4px; align-items: center;
  padding: 6px 2px;
}
.typing-indicator span {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--text-muted);
  animation: typingBounce 1.2s ease infinite;
}
.typing-indicator span:nth-child(2) { animation-delay: 0.15s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.3s; }
@keyframes typingBounce {
  0%, 60%, 100% { transform: translateY(0); }
  30% { transform: translateY(-5px); }
}

/* â”€â”€â”€ Input Bar â”€â”€â”€ */
.input-bar-wrap {
  padding: 12px 16px 20px;
  background: var(--bg-primary);
  border-top: 1px solid var(--border);
  transition: background 0.3s, border-color 0.3s;
  position: sticky; bottom: 0;
}
.input-bar {
  max-width: 720px; margin: 0 auto;
  background: var(--bg-input);
  border: 1.5px solid var(--border);
  border-radius: 18px;
  padding: 10px 14px 10px 18px;
  display: flex; align-items: flex-end; gap: 8px;
  box-shadow: var(--shadow);
  transition: border-color 0.2s, box-shadow 0.2s, background 0.3s;
}
.input-bar:focus-within {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-light), var(--shadow);
}

#messageInput {
  flex: 1; min-width: 0;
  border: none; outline: none; resize: none;
  background: transparent;
  color: var(--text-primary);
  font-family: inherit;
  font-size: 0.92rem;
  line-height: 1.55;
  max-height: 160px;
  min-height: 24px;
  transition: color 0.3s;
}
#messageInput::placeholder { color: var(--text-muted); }

.input-bar-bottom {
  display: flex; align-items: center; gap: 6px;
  justify-content: space-between;
  max-width: 720px; margin: 6px auto 0;
  padding: 0 2px;
}
.input-bar-bottom-left { display: flex; align-items: center; gap: 6px; }
.input-bar-bottom button, .input-bar-bottom-left button {
  background: none; border: none; cursor: pointer;
  color: var(--text-muted); padding: 4px 6px;
  border-radius: 7px; transition: all 0.15s;
  font-family: inherit; font-size: 0.78rem;
  display: flex; align-items: center; gap: 4px;
}
.input-bar-bottom button:hover, .input-bar-bottom-left button:hover {
  background: var(--bg-hover); color: var(--text-secondary);
}
.input-bar-bottom button svg, .input-bar-bottom-left button svg { width: 15px; height: 15px; }

#sendBtn {
  background: var(--accent); border: none; cursor: pointer;
  color: #fff; width: 40px; height: 40px; min-width: 40px;
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.2s, transform 0.1s, box-shadow 0.2s;
  box-shadow: 0 2px 8px rgba(26,115,232,0.35);
}
#sendBtn:hover { background: var(--accent-hover); box-shadow: 0 3px 12px rgba(26,115,232,0.45); }
#sendBtn:active { transform: scale(0.93); }
#sendBtn:disabled { background: var(--border); box-shadow: none; cursor: not-allowed; }
#sendBtn svg { width: 18px; height: 18px; }

.model-tag {
  font-size: 0.735rem; color: var(--text-muted);
  padding: 2px 8px; border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--bg-secondary);
  cursor: pointer; transition: all 0.15s;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  max-width: 150px;
}
.model-tag:hover { border-color: var(--accent); color: var(--accent); }

/* â”€â”€â”€ Stop Button â”€â”€â”€ */
#stopBtn {
  background: var(--danger); border: none; cursor: pointer;
  color: #fff; width: 40px; height: 40px; min-width: 40px;
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.2s; display: none;
}
#stopBtn:hover { background: var(--danger-hover); }
#stopBtn svg { width: 18px; height: 18px; }

/* â”€â”€â”€ Modals â”€â”€â”€ */
.modal-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,0.45); z-index: 500;
  align-items: center; justify-content: center;
  backdrop-filter: blur(2px);
}
.modal-overlay.show { display: flex; }
.modal {
  background: var(--bg-modal);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 28px;
  width: 90%; max-width: 460px;
  box-shadow: var(--shadow-lg);
  transition: background 0.3s, border-color 0.3s;
  max-height: 90vh; overflow-y: auto;
}
.modal-title {
  font-size: 1.1rem; font-weight: 600;
  color: var(--text-primary); margin-bottom: 20px;
  display: flex; align-items: center; justify-content: space-between;
}
.modal-title button {
  background: none; border: none; cursor: pointer;
  color: var(--text-muted); padding: 4px;
  border-radius: 6px; transition: color 0.15s;
}
.modal-title button:hover { color: var(--danger); }
.modal-title svg { width: 18px; height: 18px; }

.form-group { margin-bottom: 18px; }
.form-label {
  display: block; font-size: 0.82rem; font-weight: 500;
  color: var(--text-secondary); margin-bottom: 6px;
}
.form-input {
  width: 100%; padding: 10px 12px;
  border: 1.5px solid var(--border);
  border-radius: 9px;
  background: var(--bg-input);
  color: var(--text-primary);
  font-family: inherit; font-size: 0.87rem;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s, background 0.3s;
}
.form-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
.form-input::placeholder { color: var(--text-muted); }

textarea.form-input {
  resize: vertical; min-height: 90px; line-height: 1.5;
}

.btn-row { display: flex; gap: 8px; justify-content: flex-end; margin-top: 24px; }
.btn { padding: 9px 20px; border-radius: 9px; border: none; font-family: inherit; font-size: 0.855rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-hover); }
.btn-secondary { background: var(--bg-hover); color: var(--text-secondary); }
.btn-secondary:hover { background: var(--border); }
.btn-danger { background: var(--danger); color: #fff; }
.btn-danger:hover { background: var(--danger-hover); }

/* â”€â”€â”€ System Prompt Indicator â”€â”€â”€ */
.sys-prompt-badge {
  display: none;
  font-size: 0.73rem; color: var(--accent);
  background: var(--accent-light); padding: 2px 8px; border-radius: 20px;
  white-space: nowrap;
}
.sys-prompt-badge.show { display: inline-block; }

/* â”€â”€â”€ Scrollbar â”€â”€â”€ */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* â”€â”€â”€ Mobile â”€â”€â”€ */
@media (max-width: 768px) {
  #sidebar { transform: translateX(-100%); }
  #sidebar.open { transform: translateX(0); }
  #mainContent { margin-left: 0 !important; }
  .top-bar { display: flex; }
  .input-bar-wrap { padding: 10px 12px 28px; }
  .messages-inner { gap: 12px; }
  .modal { padding: 22px 18px; }
  #messagesArea { padding: 16px 12px 12px; }
}

@media (min-width: 769px) {
  #sidebar { transform: translateX(0); }
  .top-bar { display: none !important; }
}

/* â”€â”€â”€ Transitions â”€â”€â”€ */
.transition-all { transition: all 0.25s ease; }
</style>
</head>
<body>

<!-- ===== LOADING ===== -->
<div id="loading">Loading Appâ€¦</div>

<!-- ===== APP SHELL ===== -->
<div id="app">

  <!-- â”€â”€â”€ Sidebar Overlay (mobile) â”€â”€â”€ -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- â”€â”€â”€ SIDEBAR â”€â”€â”€ -->
  <aside id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
      </div>
      <span class="sidebar-title">AI Chat</span>
    </div>

    <button id="newChatBtn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      New Chat
    </button>

    <div id="chatList"></div>

    <div class="sidebar-footer">
      <button id="settingsBtn" title="Settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      </button>
      <button id="sysPromptBtn" title="System Prompt">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
      </button>
      <div class="footer-spacer"></div>
      <button id="darkModeBtn" title="Toggle Dark Mode">
        <svg id="darkModeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>
      </button>
    </div>
  </aside>

  <!-- â”€â”€â”€ MAIN â”€â”€â”€ -->
  <main id="mainContent">

    <!-- Top Bar (mobile only) -->
    <div class="top-bar">
      <button id="hamburgerBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <span class="top-bar-title" id="topBarTitle">New Chat</span>
      <button id="topBarSettings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      </button>
    </div>

    <!-- Messages -->
    <div id="messagesArea">
      <div class="messages-inner" id="messagesInner">
        <!-- Welcome or messages injected here -->
      </div>
    </div>

    <!-- Input Bar -->
    <div class="input-bar-wrap">
      <div class="input-bar">
        <textarea id="messageInput" rows="1" placeholder="Message AIâ€¦" autocomplete="off" spellcheck="false"></textarea>
        <button id="sendBtn" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
        <button id="stopBtn">
          <svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
        </button>
      </div>
      <div class="input-bar-bottom">
        <div class="input-bar-bottom-left">
          <span class="sys-prompt-badge" id="sysPromptBadge">âš¡ System Prompt</span>
          <button id="inlineSysPrompt">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
            System
          </button>
        </div>
        <span class="model-tag" id="modelTag">deepseek/deepseek-r1:free</span>
      </div>
    </div>
  </main>
</div>

<!-- â”€â”€â”€ SETTINGS MODAL â”€â”€â”€ -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <div class="modal-title">
      Settings
      <button id="closeSettings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="form-group">
      <label class="form-label">OpenRouter API Key</label>
      <input type="password" id="apiKeyInput" class="form-input" placeholder="sk-â€¦" autocomplete="off"/>
    </div>
    <div class="form-group">
      <label class="form-label">Model</label>
      <input type="text" id="modelInput" class="form-input" value="deepseek/deepseek-r1:free" placeholder="e.g. deepseek/deepseek-r1:free"/>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" id="cancelSettings">Cancel</button>
      <button class="btn btn-primary" id="saveSettings">Save</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ SYSTEM PROMPT MODAL â”€â”€â”€ -->
<div class="modal-overlay" id="sysPromptModal">
  <div class="modal">
    <div class="modal-title">
      System Prompt
      <button id="closeSysPrompt"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="form-group">
      <label class="form-label">Define your system prompt (applies to current chat)</label>
      <textarea id="sysPromptInput" class="form-input" placeholder="You are a helpful assistantâ€¦" rows="5"></textarea>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" id="clearSysPrompt">Clear</button>
      <button class="btn btn-primary" id="saveSysPrompt">Save</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ DELETE CONFIRM MODAL â”€â”€â”€ -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal" style="max-width:380px;">
    <div class="modal-title">Delete Chat</div>
    <p style="font-size:0.88rem;color:var(--text-secondary);margin:0 0 20px;">This will permanently delete this chat. This action cannot be undone.</p>
    <div class="btn-row">
      <button class="btn btn-secondary" id="cancelDelete">Cancel</button>
      <button class="btn btn-danger" id="confirmDelete">Delete</button>
    </div>
  </div>
</div>

<!-- ===== SCRIPT (end of body!) ===== -->
<script>
(function() {
"use strict";

/* â”€â”€â”€ STATE â”€â”€â”€ */
var chats = {};          // { chatId: { name, messages, systemPrompt } }
var currentChatId = null;
var apiKey = '';
var model = 'deepseek/deepseek-r1:free';
var darkMode = false;
var streamController = null; // AbortController for streaming
var pendingDeleteId = null;

/* â”€â”€â”€ DOM REFS â”€â”€â”€ */
var $ = function(sel){ return document.querySelector(sel); };
var $$ = function(sel){ return document.querySelectorAll(sel); };

var loadingEl = $('#loading');
var appEl = $('#app');
var sidebarEl = $('#sidebar');
var sidebarOverlay = $('#sidebarOverlay');
var chatListEl = $('#chatList');
var messagesInner = $('#messagesInner');
var messagesArea = $('#messagesArea');
var messageInput = $('#messageInput');
var sendBtn = $('#sendBtn');
var stopBtn = $('#stopBtn');
var modelTag = $('#modelTag');
var topBarTitle = $('#topBarTitle');
var sysPromptBadge = $('#sysPromptBadge');

/* â”€â”€â”€ PERSISTENCE â”€â”€â”€ */
function loadState() {
  try {
    var stored = localStorage.getItem('uai_chats');
    if (stored) chats = JSON.parse(stored);
    apiKey = localStorage.getItem('uai_apikey') || '';
    model = localStorage.getItem('uai_model') || 'deepseek/deepseek-r1:free';
    darkMode = localStorage.getItem('uai_dark') === 'true';
    currentChatId = localStorage.getItem('uai_current') || null;
  } catch(e) { console.warn('loadState error', e); }
}

function saveState() {
  try {
    localStorage.setItem('uai_chats', JSON.stringify(chats));
    localStorage.setItem('uai_apikey', apiKey);
    localStorage.setItem('uai_model', model);
    localStorage.setItem('uai_dark', String(darkMode));
    localStorage.setItem('uai_current', currentChatId || '');
  } catch(e) { console.warn('saveState error', e); }
}

/* â”€â”€â”€ UTILS â”€â”€â”€ */
function uid() {
  return 'chat_' + Date.now() + '_' + Math.random().toString(36).slice(2,9);
}

function escapeBubble(text) {
  // For user messages render plain text safely
  return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}

function renderMarkdown(text) {
  try {
    if (window.marked) {
      marked.setOptions({ breaks: true, sanitize: false });
      return marked.parse(text);
    }
  } catch(e) {}
  return escapeBubble(text);
}

/* â”€â”€â”€ DARK MODE â”€â”€â”€ */
function applyTheme() {
  if (darkMode) {
    document.documentElement.setAttribute('data-theme','dark');
  } else {
    document.documentElement.removeAttribute('data-theme');
  }
  // Toggle icon
  var icon = $('#darkModeIcon');
  if (icon) {
    if (darkMode) {
      icon.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
    } else {
      icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
    }
  }
}

/* â”€â”€â”€ CHAT MANAGEMENT â”€â”€â”€ */
function createChat() {
  var id = uid();
  chats[id] = { name: 'New Chat', messages: [], systemPrompt: '' };
  currentChatId = id;
  saveState();
  renderChatList();
  renderMessages();
  updateTopBar();
  return id;
}

function deleteChat(id) {
  if (chats[id]) {
    delete chats[id];
    if (currentChatId === id) {
      // Pick another chat or create new
      var keys = Object.keys(chats);
      currentChatId = keys.length > 0 ? keys[keys.length - 1] : null;
      if (!currentChatId) createChat();
    }
    saveState();
    renderChatList();
    renderMessages();
    updateTopBar();
  }
}

function renameChat(id, newName) {
  if (chats[id]) {
    chats[id].name = newName || 'New Chat';
    saveState();
    renderChatList();
    updateTopBar();
  }
}

function selectChat(id) {
  if (!chats[id]) return;
  currentChatId = id;
  saveState();
  renderChatList();
  renderMessages();
  updateTopBar();
  closeSidebar();
}

/* â”€â”€â”€ RENDER CHAT LIST â”€â”€â”€ */
function renderChatList() {
  if (!chatListEl) return;
  chatListEl.innerHTML = '';
  var keys = Object.keys(chats);
  // reverse so newest first
  for (var i = keys.length - 1; i >= 0; i--) {
    var id = keys[i];
    var chat = chats[id];
    var isActive = id === currentChatId;
    var item = document.createElement('div');
    item.className = 'chat-item' + (isActive ? ' active' : '');
    item.dataset.chatId = id;

    var icon = document.createElement('span');
    icon.className = 'chat-item-icon';
    icon.textContent = 'ðŸ’¬';

    var name = document.createElement('span');
    name.className = 'chat-item-name';
    name.textContent = chat.name;
    name.title = chat.name;

    var actions = document.createElement('div');
    actions.className = 'chat-item-actions';

    // Rename button
    var renameBtn = document.createElement('button');
    renameBtn.title = 'Rename';
    renameBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
    renameBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      startRename(id);
    });

    // Delete button
    var delBtn = document.createElement('button');
    delBtn.className = 'danger';
    delBtn.title = 'Delete';
    delBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>';
    delBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      openDeleteConfirm(id);
    });

    actions.appendChild(renameBtn);
    actions.appendChild(delBtn);

    item.appendChild(icon);
    item.appendChild(name);
    item.appendChild(actions);

    item.addEventListener('click', function() { selectChat(id); });
    chatListEl.appendChild(item);
  }
}

function startRename(id) {
  var item = chatListEl.querySelector('[data-chat-id="'+id+'"]');
  if (!item) return;
  var nameEl = item.querySelector('.chat-item-name');
  if (!nameEl) return;
  var input = document.createElement('input');
  input.type = 'text';
  input.className = 'chat-item-name-input';
  input.value = chats[id] ? chats[id].name : '';
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') { finishRename(id, input.value); }
    if (e.key === 'Escape') { renderChatList(); }
  });
  input.addEventListener('blur', function() { finishRename(id, input.value); });
  nameEl.replaceWith(input);
  input.focus();
  input.select();
}

function finishRename(id, val) {
  renameChat(id, val.trim());
}

/* â”€â”€â”€ DELETE CONFIRM â”€â”€â”€ */
function openDeleteConfirm(id) {
  pendingDeleteId = id;
  $('#deleteModal').classList.add('show');
}

$('#cancelDelete') && $('#cancelDelete').addEventListener('click', function() {
  $('#deleteModal').classList.remove('show');
  pendingDeleteId = null;
});
$('#confirmDelete') && $('#confirmDelete').addEventListener('click', function() {
  if (pendingDeleteId) {
    deleteChat(pendingDeleteId);
    pendingDeleteId = null;
  }
  $('#deleteModal').classList.remove('show');
});

/* â”€â”€â”€ RENDER MESSAGES â”€â”€â”€ */
function renderMessages() {
  if (!messagesInner) return;
  messagesInner.innerHTML = '';

  if (!currentChatId || !chats[currentChatId]) {
    showWelcome();
    return;
  }

  var msgs = chats[currentChatId].messages;
  if (!msgs || msgs.length === 0) {
    showWelcome();
    return;
  }

  msgs.forEach(function(msg, idx) {
    appendMessageBubble(msg.role, msg.content, idx);
  });

  scrollToBottom();
  updateSysPromptBadge();
}

function showWelcome() {
  messagesInner.innerHTML =
    '<div id="welcomeScreen">' +
    '<div class="welcome-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>' +
    '<div class="welcome-title">Hello! I\'m your AI Assistant</div>' +
    '<div class="welcome-sub">Ask me anything â€” I\'m powered by OpenRouter. Set your API key in <strong>Settings</strong> to get started.</div>' +
    '</div>';
}

function appendMessageBubble(role, content, idx) {
  var isUser = role === 'user';
  var div = document.createElement('div');
  div.className = 'message ' + (isUser ? 'user' : 'ai');
  if (idx !== undefined) div.dataset.msgIndex = idx;

  var avatar = document.createElement('div');
  avatar.className = 'message-avatar';
  avatar.textContent = isUser ? 'You' : 'AI';

  var bubble = document.createElement('div');
  bubble.className = 'message-bubble';
  if (isUser) {
    bubble.innerHTML = escapeBubble(content);
  } else {
    bubble.innerHTML = renderMarkdown(content);
  }

  div.appendChild(avatar);
  div.appendChild(bubble);
  messagesInner.appendChild(div);
  return { div: div, bubble: bubble };
}

function scrollToBottom() {
  if (messagesArea) {
    messagesArea.scrollTop = messagesArea.scrollHeight;
  }
}

function updateTopBar() {
  if (!topBarTitle || !currentChatId || !chats[currentChatId]) return;
  topBarTitle.textContent = chats[currentChatId].name;
}

function updateSysPromptBadge() {
  if (!currentChatId || !chats[currentChatId]) { sysPromptBadge.classList.remove('show'); return; }
  if (chats[currentChatId].systemPrompt && chats[currentChatId].systemPrompt.trim()) {
    sysPromptBadge.classList.add('show');
  } else {
    sysPromptBadge.classList.remove('show');
  }
}

/* â”€â”€â”€ AUTO-NAME CHAT â”€â”€â”€ */
function autoNameChat(userMsg) {
  if (!currentChatId || !chats[currentChatId]) return;
  if (chats[currentChatId].name !== 'New Chat') return;
  // Simple: first 40 chars of user message
  var name = userMsg.replace(/\n/g, ' ').slice(0, 42);
  if (name.length < userMsg.replace(/\n/g,' ').length) name += 'â€¦';
  chats[currentChatId].name = name || 'New Chat';
  saveState();
  renderChatList();
  updateTopBar();
}

/* â”€â”€â”€ SIDEBAR TOGGLE â”€â”€â”€ */
function openSidebar() {
  sidebarEl.classList.add('open');
  sidebarOverlay.classList.add('show');
}
function closeSidebar() {
  sidebarEl.classList.remove('open');
  sidebarOverlay.classList.remove('show');
}

/* â”€â”€â”€ SETTINGS MODAL â”€â”€â”€ */
function openSettings() {
  $('#apiKeyInput').value = apiKey;
  $('#modelInput').value = model;
  $('#settingsModal').classList.add('show');
}
function closeSettings() { $('#settingsModal').classList.remove('show'); }

$('#settingsBtn') && $('#settingsBtn').addEventListener('click', openSettings);
$('#topBarSettings') && $('#topBarSettings').addEventListener('click', openSettings);
$('#closeSettings') && $('#closeSettings').addEventListener('click', closeSettings);
$('#cancelSettings') && $('#cancelSettings').addEventListener('click', closeSettings);
$('#saveSettings') && $('#saveSettings').addEventListener('click', function() {
  apiKey = $('#apiKeyInput').value.trim();
  model = $('#modelInput').value.trim() || 'deepseek/deepseek-r1:free';
  saveState();
  if (modelTag) modelTag.textContent = model;
  closeSettings();
});
// Close modal on overlay click
$('#settingsModal') && $('#settingsModal').addEventListener('click', function(e) {
  if (e.target === $('#settingsModal')) closeSettings();
});

/* â”€â”€â”€ SYSTEM PROMPT MODAL â”€â”€â”€ */
function openSysPrompt() {
  var sp = (currentChatId && chats[currentChatId]) ? chats[currentChatId].systemPrompt || '' : '';
  $('#sysPromptInput').value = sp;
  $('#sysPromptModal').classList.add('show');
}
function closeSysPromptModal() { $('#sysPromptModal').classList.remove('show'); }

$('#sysPromptBtn') && $('#sysPromptBtn').addEventListener('click', openSysPrompt);
$('#inlineSysPrompt') && $('#inlineSysPrompt').addEventListener('click', openSysPrompt);
$('#closeSysPrompt') && $('#closeSysPrompt').addEventListener('click', closeSysPromptModal);
$('#saveSysPrompt') && $('#saveSysPrompt').addEventListener('click', function() {
  if (currentChatId && chats[currentChatId]) {
    chats[currentChatId].systemPrompt = $('#sysPromptInput').value.trim();
    saveState();
    updateSysPromptBadge();
  }
  closeSysPromptModal();
});
$('#clearSysPrompt') && $('#clearSysPrompt').addEventListener('click', function() {
  $('#sysPromptInput').value = '';
});
$('#sysPromptModal') && $('#sysPromptModal').addEventListener('click', function(e) {
  if (e.target === $('#sysPromptModal')) closeSysPromptModal();
});
// Clicking badge opens modal
sysPromptBadge && sysPromptBadge.addEventListener('click', openSysPrompt);

/* â”€â”€â”€ DARK MODE â”€â”€â”€ */
$('#darkModeBtn') && $('#darkModeBtn').addEventListener('click', function() {
  darkMode = !darkMode;
  applyTheme();
  saveState();
});

/* â”€â”€â”€ MODEL TAG (open settings) â”€â”€â”€ */
modelTag && modelTag.addEventListener('click', openSettings);

/* â”€â”€â”€ HAMBURGER â”€â”€â”€ */
$('#hamburgerBtn') && $('#hamburgerBtn').addEventListener('click', function() {
  openSidebar();
});
sidebarOverlay && sidebarOverlay.addEventListener('click', closeSidebar);

/* â”€â”€â”€ NEW CHAT â”€â”€â”€ */
$('#newChatBtn') && $('#newChatBtn').addEventListener('click', function() {
  createChat();
  closeSidebar();
});

/* â”€â”€â”€ INPUT HANDLERS â”€â”€â”€ */
messageInput && messageInput.addEventListener('input', function() {
  sendBtn.disabled = !messageInput.value.trim();
  // auto resize
  messageInput.style.height = 'auto';
  messageInput.style.height = messageInput.scrollHeight + 'px';
});

messageInput && messageInput.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    trySend();
  }
});

sendBtn && sendBtn.addEventListener('click', trySend);
stopBtn && stopBtn.addEventListener('click', function() {
  if (streamController) {
    streamController.abort();
    streamController = null;
  }
  stopBtn.style.display = 'none';
  sendBtn.style.display = 'flex';
});

/* â”€â”€â”€ SEND MESSAGE â”€â”€â”€ */
function trySend() {
  var text = messageInput ? messageInput.value.trim() : '';
  if (!text) return;
  if (!apiKey) {
    alert('Please set your OpenRouter API Key in Settings first.');
    openSettings();
    return;
  }

  // Ensure chat exists
  if (!currentChatId || !chats[currentChatId]) createChat();

  // Add user message
  chats[currentChatId].messages.push({ role: 'user', content: text });
  autoNameChat(text);
  saveState();
  renderMessages();

  // Clear input
  messageInput.value = '';
  messageInput.style.height = 'auto';
  sendBtn.disabled = true;

  // Start streaming
  streamResponse();
}

/* â”€â”€â”€ STREAMING API CALL â”€â”€â”€ */
function streamResponse() {
  if (!currentChatId || !chats[currentChatId]) return;

  // Show typing indicator
  var typingDiv = document.createElement('div');
  typingDiv.className = 'message ai';
  typingDiv.id = 'typingMsg';
  var typAvatar = document.createElement('div');
  typAvatar.className = 'message-avatar';
  typAvatar.textContent = 'AI';
  var typBubble = document.createElement('div');
  typBubble.className = 'message-bubble';
  typBubble.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
  typingDiv.appendChild(typAvatar);
  typingDiv.appendChild(typBubble);
  messagesInner.appendChild(typingDiv);
  scrollToBottom();

  // Show stop, hide send
  stopBtn.style.display = 'flex';
  sendBtn.style.display = 'none';
  messageInput.disabled = true;

  // Build messages array
  var msgs = [];
  var sp = chats[currentChatId].systemPrompt;
  if (sp && sp.trim()) {
    msgs.push({ role: 'system', content: sp.trim() });
  }
  chats[currentChatId].messages.forEach(function(m) {
    msgs.push({ role: m.role, content: m.content });
  });

  streamController = new AbortController();

  fetch('https://openrouter.ai/api/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + apiKey,
      'HTTP-Referer': window.location.href || 'https://localhost',
      'X-Title': 'Universal AI Chat'
    },
    body: JSON.stringify({
      model: model,
      messages: msgs,
      stream: true
    }),
    signal: streamController.signal
  })
  .then(function(response) {
    if (!response.ok) {
      return response.text().then(function(t) { throw new Error('API Error ' + response.status + ': ' + t); });
    }
    return response.body;
  })
  .then(function(body) {
    var reader = body.getReader();
    var decoder = new TextDecoder();
    var accumulated = '';
    var buffer = '';

    // Replace typing with actual bubble
    var replaced = false;
    function ensureBubble() {
      if (!replaced) {
        replaced = true;
        typBubble.innerHTML = '';
      }
    }

    function pump() {
      return reader.read().then(function(result) {
        if (result.done) {
          // Finalize
          ensureBubble();
          // Final render with markdown
          if (currentChatId && chats[currentChatId]) {
            chats[currentChatId].messages.push({ role: 'assistant', content: accumulated });
            saveState();
            // Re-render last bubble with full markdown
            typBubble.innerHTML = renderMarkdown(accumulated);
          }
          finishStream();
          return;
        }

        var chunk = decoder.decode(result.value, { stream: true });
        buffer += chunk;

        // Process SSE lines
        var lines = buffer.split('\n');
        buffer = lines.pop(); // keep incomplete line

        lines.forEach(function(line) {
          line = line.trim();
          if (!line || line === 'data: [DONE]') return;
          if (line.indexOf('data: ') === 0) {
            var json = line.slice(6);
            try {
              var data = JSON.parse(json);
              var delta = data && data.choices && data.choices[0] && data.choices[0].delta;
              if (delta && delta.content) {
                ensureBubble();
                accumulated += delta.content;
                // Live render: plain text with newlines for speed, then full markdown at end
                typBubble.innerHTML = escapeBubble(accumulated);
                scrollToBottom();
              }
            } catch(e) { /* skip malformed */ }
          }
        });

        return pump();
      });
    }

    return pump();
  })
  .catch(function(err) {
    if (err && err.name === 'AbortError') {
      // User stopped
      if (currentChatId && chats[currentChatId]) {
        // Save what we have so far â€” find accumulated from bubble
        var bubbleText = typBubble.textContent || '';
        if (bubbleText.trim()) {
          chats[currentChatId].messages.push({ role: 'assistant', content: bubbleText.trim() });
          saveState();
          typBubble.innerHTML = renderMarkdown(bubbleText.trim());
        }
      }
      finishStream();
      return;
    }
    // Error
    ensureBubble();
    typBubble.innerHTML = '<span style="color:var(--danger);font-size:0.85rem;">âš  ' + (err ? err.message || 'Unknown error' : 'Unknown error') + '</span>';
    finishStream();

    function ensureBubble() {
      if (typBubble.querySelector('.typing-indicator')) typBubble.innerHTML = '';
    }
  });
}

function finishStream() {
  streamController = null;
  stopBtn.style.display = 'none';
  sendBtn.style.display = 'flex';
  if (messageInput) messageInput.disabled = false;
  messageInput && messageInput.focus();
}

/* â”€â”€â”€ INIT â”€â”€â”€ */
function init() {
  loadState();
  applyTheme();

  // Ensure at least one chat
  if (Object.keys(chats).length === 0) {
    createChat();
  } else {
    if (!currentChatId || !chats[currentChatId]) {
      var keys = Object.keys(chats);
      currentChatId = keys[keys.length - 1];
    }
  }

  // Apply model tag
  if (modelTag) modelTag.textContent = model;

  // Render
  renderChatList();
  renderMessages();
  updateTopBar();
  updateSysPromptBadge();

  // Hide loader, show app
  loadingEl.classList.add('hidden');
  appEl.classList.add('visible');

  // Mobile: sidebar initially hidden on small screens (CSS handles)
  // Desktop: sidebar visible (CSS handles)

  // Focus input
  if (messageInput) messageInput.focus();
}

// Run init
init();

})(); // end IIFE
</script>
</body>
</html>
